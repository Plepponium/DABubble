<div class="chats">
    <app-channel-header 
        [channelId]="channelId" 
        [channelName$]="channelName$"
        [profileOpen]="profileOpen" 
        [currentUserId]="currentUserId"
        [participants]="participants" 
        [participants$]="participants$"
        (openProfile)="openDialogueShowProfile($event)"
        (channelDeleted)="handleChannelDeleted()" >
    </app-channel-header>

    <div *ngIf="(chats$ | async) as chatList" class="chat-content">
        <div id="chat-history" #chatHistory class="chat-history">

            <div *ngFor="let chat of chatList; let i = index; trackBy: trackByChatId" class="chat-day-section"
                [ngClass]="{'reverse': chat.user === currentUserId}" #chatSection [attr.data-message-id]="chat.id">

                <!-- <div *ngIf="i === 0 || !isSameDate(getChatDate(chat), getChatDate(chatList[i-1]))"
                    class="chat-date-section">
                    <div class="chat-date">{{ getDisplayDate(chat) }}</div>
                </div> -->

                <!-- <div class="chat-section" [ngClass]="{'reverse': chat.user === currentUserId}"
                    [class.edit-mode]="chat.isEditing">
                    <div class="chat-dialogue" [ngClass]="{'reverse': chat.user === currentUserId}">
                        <button (click)="addReaction(i, 'check')" class="add-reaction-btn">
                            <img class="smiley-img" src="assets/reaction-icons/check.svg" alt="">
                        </button>

                        <button (click)="addReaction(i, 'thumb')" class="add-reaction-btn">
                            <img class="smiley-img" src="assets/reaction-icons/thumb.svg" alt="">
                        </button>

                        <div class="reactions-display-container">
                            <div class="add-reaction-dialogue" *ngIf="activeReactionDialogueIndex === i">
                                <div *ngFor="let icon of reactionIcons" class="reactions-container">
                                    <button (click)="addReaction(i, icon)" class="add-reaction-btn">
                                        <img class="smiley-img" [src]="'assets/reaction-icons/' + icon + '.svg'"
                                            [alt]="icon">
                                    </button>
                                </div>
                            </div>
                            <button (click)="openReactionsDialogue(i, false)" class="add-reaction-btn">
                                <img class="hover-icon" src="assets/message-icons/add_reaction.svg" alt="">
                                <img class="hover-icon-purple" src="assets/message-icons/add_reaction-purple.svg"
                                    alt="">
                            </button>
                        </div>

                        <button (click)="openAddComment(chat)" class="add-reaction-btn">
                            <img class="hover-icon" src="assets/icons/comment.svg" alt="">
                            <img class="hover-icon-purple" src="assets/icons/comment-purple.svg" alt="">
                        </button>

                        <div class="edit-comment-container">
                            <div class="edit-comment-dialogue" *ngIf="editCommentDialogueExpanded">
                                <div class="edit-comment" (click)="enableEditChat(chat)">Nachricht bearbeiten</div>
                            </div>
                            <button (click)="openEditCommentDialogue()" class="add-reaction-btn reverse">
                                <img class="hover-icon" src="assets/message-icons/more_vert.svg" alt="">
                                <img class="hover-icon-purple" src="assets/message-icons/more_vert-purple.svg" alt="">
                            </button>
                        </div>
                    </div>

                    <img class="chat-user-img" [src]="'assets/user-icons/' + chat.userImg + '.svg'"
                        [alt]="chat.userName" [ngClass]="{'grayscale': chat.isUserMissing}">

                    <ng-container *ngIf="!chat.isEditing; else editMode">
                        <div class="chat-info-container" [ngClass]="{'reverse': chat.user === currentUserId}">
                            <div class="chat-start" [ngClass]="{'reverse': chat.user === currentUserId}">
                                <div class="font-w-700 user-name" [ngClass]="{'missing': chat.isUserMissing}"
                                    (click)="handleOpenProfile(chat)">{{ chat.userName }}
                                </div>
                                <div class="font-14 t-gray">{{ chat.time * 1000 | date: 'HH:mm' }} Uhr</div>
                            </div>
                            <div class="chat-message" [ngClass]="{'left bg-light-purple': chat.user !== currentUserId, 
                                'right': chat.user === currentUserId}" [innerHTML]="renderMessage(chat.message)">
                            </div>
                            <div class="chat-answered" [ngClass]="{'right': chat.user === currentUserId}"
                                [ngClass]="{'has-answers': chat.answersCount && chat.answersCount > 0}">

                                <div class="answers" *ngIf="chat.answersCount && chat.answersCount > 0">
                                    <div (click)="handleOpenThread(chat.id)" class="answer t-purple">
                                        {{ chat.answersCount }} Antworten
                                    </div>
                                    <div class="last-answer font-14 t-gray hide-small">
                                        Letzte Antwort {{ chat.lastAnswerTime ? (chat.lastAnswerTime * 1000 | date: 'HH:mm') : '' }}
                                    </div>
                                </div>

                                

                                <app-reactions-display
                                    [chat]="chat"
                                    [index]="i"
                                    [currentUserId]="currentUserId"
                                    [isResponsive]="isResponsive"
                                    [reactionIcons]="reactionIcons"
                                    [activeReactionDialogueIndex]="activeReactionDialogueIndex"
                                    [activeReactionDialogueBelowIndex]="activeReactionDialogueBelowIndex"
                                    [showAllReactions]="showAllReactions"
                                    (addReaction)="addReaction($event.index, $event.type)"
                                    (toggleReaction)="toggleReaction($event.index, $event.type)"
                                    (openReactionsDialogue)="openReactionsDialogue($event.index, $event.below)"
                                    (showAllReactionsChange)="showAllReactions[$event.index] = $event.showAll">
                                </app-reactions-display>

                            </div>
                        </div>
                    </ng-container>

                    <ng-template #editMode>
                        <div class="chat-edit-wrapper">
                            <textarea #editTa id="edit-{{chat.id}}" class="edit-textarea"
                                (input)="updateEditCaret(chat, editTa); autoGrow(editTa)"
                                (keyup)="updateEditCaret(chat, editTa)" [(ngModel)]="chat.editedText"
                                [placeholder]="chat.message"></textarea>

                            <app-mentions-overlay [text]="chat.editedText" [caretIndex]="chat._caretIndex"
                                [currentUserId]="currentUserId" [context]="'Channel'" [users]="participants"
                                [channels]="filteredChannels" (mentionSelected)="insertMentionInEdit(chat, $event)">
                            </app-mentions-overlay>

                            <div class="edit-actions">
                                <button class="btn cancel" (click)="cancelEditChat(chat)">Abbrechen</button>
                                <button class="btn save" (click)="saveEditedChat(chat)">Speichern</button>
                            </div>
                        </div>
                    </ng-template>

                </div> -->
            

                <app-chat-message
                    [chat]="chat"
                    [index]="i"
                    [prevChatDate]="i > 0 ? getChatDate(chatList[i-1]) : undefined"
                    [currentUserId]="currentUserId"
                    [isResponsive]="isResponsive"
                    [participants]="participants"
                    [filteredChannels]="filteredChannels"
                    [activeReactionDialogueIndex]="activeReactionDialogueIndex"
                    [activeReactionDialogueBelowIndex]="activeReactionDialogueBelowIndex"
                    [showAllReactions]="showAllReactions"
                    [reactionIcons]="reactionIcons"
                    #chatSection [attr.data-message-id]="chat.id"
                    (openThread)="handleOpenThread(chat.id)"
                    (openProfile)="handleOpenProfile($event)"
                    (addReaction)="addReaction($event)"
                    (toggleReaction)="toggleReaction($event)"
                    (openReactionsDialogue)="openReactionsDialogue($event)"
                    (enableEditChat)="enableEditChat($event)"
                    (cancelEditChat)="cancelEditChat($event)"
                    (saveEditedChat)="saveEditedChat($event)">
                </app-chat-message>
            </div>

        </div>

        <!-- <form class="form" (ngSubmit)="submitChatMessage()" #chatForm="ngForm">
            <div class="form-field" (click)="focusInput($event)">
                <ng-container *ngIf="channelName$ | async as channelName">
                    <textarea #messageInput id="chat-message" class="input" name="message" [(ngModel)]="newMessage"
                        (keydown.enter)="onEnterPress($any($event))" type="text"
                        [placeholder]="'Nachricht an #' + channelName"
                        (input)="updateCaretPosition(); autoGrow(messageInput)"
                        (keyup)="updateCaretPosition()"></textarea>

                    <app-smiley-overlay [active]="activeSmiley" [emojis]="reactionIcons"
                        (selected)="onSmileySelected($event, messageInput)" (activeChange)="activeSmiley = $event">
                    </app-smiley-overlay>
                    <app-mentions-overlay [text]="newMessage" [caretIndex]="mentionCaretIndex"
                        [currentUserId]="currentUserId" [context]="'Channel'" [users]="(participants$ | async) || [] "
                        [channels]="filteredChannels" (mentionSelected)="insertMention($event)"
                        (overlayStateChange)="overlayActive = $event">
                    </app-mentions-overlay>

                    <div class="input-icon-bar">
                        <div class="icon-bar t-gray">
                            <app-round-btn iconSrc="assets/message-icons/sentiment_satisfied-gray.svg"
                                iconHoverSrc="assets/message-icons/sentiment_satisfied-purple.svg"
                                altText="Reaktion hinzufügen" [type]="'button'" (click)="openSmileyOverlay()">
                            </app-round-btn>
                            <app-round-btn iconSrc="assets/message-icons/alternate_email-gray.svg"
                                iconHoverSrc="assets/message-icons/alternate_email-purple.svg"
                                altText="Empfänger hinzufügen" [type]="'button'"
                                (click)="insertAtCursor('@', messageInput)">
                            </app-round-btn>
                        </div>

                        <app-round-btn style="--btn-bg-hover: #ffffff;" iconSrc="assets/message-icons/send-purple.svg"
                            iconHoverSrc="assets/message-icons/send-purple2.svg" altText="Senden" type="submit">
                        </app-round-btn>
                    </div>
                </ng-container>

            </div>
        </form> -->

        <ng-container *ngIf="channelName$ | async as channelName">
            <app-chat-input
                [placeholder]="'Nachricht an #' + channelName"
                [(text)]="newMessage"
                [emojis]="reactionIcons"
                [users]="(participants$ | async) || []"
                [channels]="filteredChannels"
                [currentUserId]="currentUserId"
                [context]="'Channel'"
                (submit)="submitChatMessage()">
            </app-chat-input>
        </ng-container>

    </div>
</div>