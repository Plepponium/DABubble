<div class="dm-chats" *ngIf="otherUser as u">

    <div class="header">
        <div class="user" (click)="openProfile.emit(u.uid)">
            <div class="img-container">
                <img class="user-img" [src]="'assets/user-icons/' + (u.img || 'default-user') + '.svg'" />
                <div [class]="'online-signal ' + (u.presence || 'offline')"></div>
            </div>
            <span class="font-w-700 font-24">
                {{ u.name }} <span *ngIf="isSelf()">(Du)</span>
            </span>
        </div>
    </div>

    <div class="dm-chat-container">

        <ng-container *ngIf="messages$ | async as messages; else loading">
            <ng-container *ngIf="users$ | async as users">
                <div *ngIf="messages.length === 0; else chatContent" class="empty-conversation">
                    <div class="recipient">
                        <img class="recipient-img" (click)="openProfile.emit(u.uid)"
                            [src]="'assets/user-icons/' + (u.img || 'default-user') + '.svg'" />
                        <span class="font-w-700 font-24" (click)="openProfile.emit(u.uid)">
                            {{ u.name }} <span *ngIf="isSelf()">(Du)</span>
                        </span>
                    </div>

                    <span class="t-gray" *ngIf="!isSelf()">
                        Diese Unterhaltung findet nur zwischen
                        <span class="t-purple at-name">&#64;{{ u.name }}</span>
                        und dir statt.
                    </span>

                    <span class="t-gray" *ngIf="isSelf()">
                        <span class="font-w-700">Dieser Raum ist nur für dich da.</span>
                        Mache dir Notizen, liste deine To-dos auf oder bewahre Links und Dateien griffbereit auf.
                        Du kannst hier auch gerne Dinge mit dir selbst besprechen.
                    </span>
                </div>

                <ng-template #chatContent>
                    <div class="chat-content" id="dm-chat-content">
                        <div class="chat-history">
                            <div *ngFor="let m of messages; let i = index" class="chat-day-section">
                                <div *ngIf="i === 0 || !isSameDate(m.sentAt?.toDate(), messages[i-1]?.sentAt?.toDate())"
                                    class="chat-date-section">
                                    <div class="line"></div>
                                    <div class="chat-date">
                                        {{ getDisplayDate(m.sentAt?.toDate()) }}
                                    </div>
                                    <div class="line"></div>
                                </div>

                                <div class="chat-message-row" [class.me]="m.senderId === currentUser?.uid">
                                    <img class="chat-user-img"
                                        [src]="'assets/user-icons/' + (m.senderImg || 'default-user') + '.svg'" />

                                    <ng-container *ngIf="!m.isEditing; else editMode">
                                        <div class="chat-bubble">
                                            <div class="chat-meta">
                                                <span class="sender-name font-w-700 font-18"
                                                    (click)="openProfile.emit(m.senderId)">{{ m.senderName }}
                                                </span>
                                                <span class="time t-gray font-14">
                                                    {{ m.sentAt?.toDate ? (m.sentAt.toDate() | date:'HH:mm') : '' }} Uhr
                                                </span>
                                            </div>

                                            <div class="chat-text font-18">{{ m.text }}</div>



                                            <div class="reactions">
                                                <div class="reaction-btns">
                                                    <ng-container *ngFor="let icon of reactionIcons">
                                                        <div class="reaction-btn"
                                                            *ngIf="m.reactions && m.reactions[icon]?.length > 0"
                                                            (click)="onReactionClick(m, icon)">
                                                            <img [src]="'assets/reaction-icons/' + icon + '.svg'"
                                                                alt="reaction icon" />
                                                            <span>{{ m.reactions[icon].length }}</span>

                                                            <div class="r-btn-hover-display">
                                                                <div class="r-btn-hover-display-content">
                                                                    <img [src]="'assets/reaction-icons/' + icon + '.svg'"
                                                                        alt="reaction" />
                                                                    <div class="reaction-btn-t-box">
                                                                        <div class="font-w-700">{{
                                                                            getReactionHoverText(m.reactions[icon]) }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </ng-container>
                                                </div>

                                                <div class="reaction-display-container">
                                                    <app-round-btn iconSrc="assets/message-icons/add_reaction.svg"
                                                        iconHoverSrc="assets/message-icons/add_reaction-purple.svg"
                                                        (click)="toggleReactionDialog(m.id, 'chat')">
                                                    </app-round-btn>

                                                    <app-reaction-icons-dialog [reactionIcons]="reactionIcons"
                                                        [isOpen]="activeReactionDialog.messageId === m.id && activeReactionDialog.source === 'chat'"
                                                        [position]="m.senderId === currentUser?.uid ? 'right' : 'left'"
                                                        [source]="'chat'" [messageId]="m.id"
                                                        (addReactionEvent)="addReaction($event)"
                                                        (toggleEvent)="toggleReactionDialog(m.id, 'chat')"
                                                        (editMessageEvent)="enableEditMessage(m)">
                                                    </app-reaction-icons-dialog>
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>

                                    <ng-template #editMode>
                                        <div class="chat-edit-wrapper">
                                            <textarea #editTa id="edit-{{m.id}}" class="edit-textarea"
                                                (input)="autoGrow(editTa)" [(ngModel)]="m.editedText"
                                                [placeholder]="m.text"></textarea>
                                            <div class="edit-actions">
                                                <button class="btn cancel"
                                                    (click)="cancelEditMessage(m)">Abbrechen</button>
                                                <button class="btn save"
                                                    (click)="saveEditedMessage(m)">Speichern</button>

                                            </div>
                                        </div>
                                    </ng-template>



                                    <app-dm-reactions-dialog class="dm-reactions-dialog-hover" *ngIf="m.id"
                                        [class.reverse]="m.senderId === currentUser?.uid" [messageId]="m.id"
                                        [messageText]="m.text" [isOwnMessage]="m.senderId === currentUser?.uid"
                                        [isOpen]="activeReactionDialog.messageId === m.id && activeReactionDialog.source === 'hover'"
                                        [reactionIcons]="reactionIcons" (addReactionEvent)="addReaction($event)"
                                        (toggleReactionsEvent)="toggleReactionDialog($event, 'hover')"
                                        (startEditEvent)="enableEditMessage(m)"
                                        (saveEditEvent)="updateMessageText($event)">
                                    </app-dm-reactions-dialog>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-template>

            </ng-container>
        </ng-container>

        <div class="form-field-wrapper">
            <div class="form-field full-width">
                <textarea #messageInput class="input font-18" [(ngModel)]="messageText"
                    [placeholder]="'Nachricht an ' + u.name"></textarea>
                <div class="input-icon-bar">
                    <div class="icon-bar t-gray">
                        <app-round-btn iconSrc="assets/message-icons/sentiment_satisfied-gray.svg"
                            iconHoverSrc="assets/message-icons/sentiment_satisfied-purple.svg"
                            altText="Reaktion hinzufügen"></app-round-btn>
                        <app-round-btn iconSrc="assets/message-icons/alternate_email-gray.svg"
                            iconHoverSrc="assets/message-icons/alternate_email-purple.svg"
                            altText="Mail hinzufügen"></app-round-btn>
                    </div>

                    <app-round-btn style="--btn-bg-hover: #ffffff;" iconSrc="assets/message-icons/send-purple.svg"
                        iconHoverSrc="assets/message-icons/send-purple2.svg" altText="Senden"
                        (click)="sendMessage()"></app-round-btn>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #loading>
    <div class="dm-loading">Lade Unterhaltung…</div>
</ng-template>